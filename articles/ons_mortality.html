<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building the ONS mortality dataset • NHSRdatasets</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building the ONS mortality dataset">
<meta property="og:description" content="NHSRdatasets">
<meta property="og:image" content="https://nhs-r-community.github.io/NHSRdatasets/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-146859070-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146859070-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NHSRdatasets</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/LOS_model.html">LOS_model: A simulated hospital length-of-stay dataset</a>
    </li>
    <li>
      <a href="../articles/ae_attendances.html">ae_attendances dataset</a>
    </li>
    <li>
      <a href="../articles/ons_mortality.html">Building the ONS mortality dataset</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhs-r-community/NHSRdatasets">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Building the ONS mortality dataset</h1>
                        <h4 class="author"><a href="mailto:zoe.turner@nhs.net">Zoë Turner</a></h4>
            
            <h4 class="date">23/04/2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nhs-r-community/NHSRdatasets/blob/master/vignettes/ons_mortality.Rmd"><code>vignettes/ons_mortality.Rmd</code></a></small>
      <div class="hidden name"><code>ons_mortality.Rmd</code></div>

    </div>

    
    
<p>This vignette details why and how the <code>ons_mortality</code> dataset was created.</p>
<p>The data were pulled together from the weekly xls spreadsheets provided by the Office of National Statistics (ONS) from 2010 to 2019 for training purposes and is a static data set.</p>
<p>Data is released every Friday and includes provisionally registered deaths for England and Wales for:</p>
<ul>
<li>Total, all deaths</li>
<li>regions of usual residence</li>
<li>age bands (persons and for males/females)</li>
<li>by underlying cause ‘All respiratory diseases’ (the methodology has changed over the years, see the subsection for more information)</li>
</ul>
<div id="further-notes-taken-from-the-spreadsheet" class="section level3">
<h3 class="hasAnchor">
<a href="#further-notes-taken-from-the-spreadsheet" class="anchor"></a>Further notes taken from the spreadsheet:</h3>
<p>1 This average is based on the actual number of death registrations recorded for each corresponding week over the previous five years. Moveable public holidays, when register offices are closed, affect the number of registrations made in the published weeks and in the corresponding weeks in previous years.</p>
<p>2 Counts of deaths by underlying cause exclude deaths at age under 28 days.</p>
<p>3 Coding of deaths by underlying cause for the latest week is not yet complete.</p>
<p>4 Does not include deaths where age is either missing or not yet fully coded. For this reason counts of ‘Persons’, ‘Males’ and ‘Females’ may not sum to ‘Total Deaths, all ages’.</p>
<p>5 Does not include deaths of those resident outside England and Wales or those records where the place of residence is either missing or not yet fully coded. For this reason counts for “Deaths by Region of usual residence” may not sum to “Total deaths, all ages”.</p>
</div>
<div id="later-confirmation-of-deaths" class="section level3">
<h3 class="hasAnchor">
<a href="#later-confirmation-of-deaths" class="anchor"></a>Later confirmation of deaths</h3>
<p>Aggregate numbers of deaths are later confirmed and released in by <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/datasets/monthlyfiguresondeathsregisteredbyareaofusualresidence">ONS monthly</a>. Numbers are released at a lower geographical level to the weekly data.</p>
</div>
<div id="preparation-of-data" class="section level2">
<h2 class="hasAnchor">
<a href="#preparation-of-data" class="anchor"></a>Preparation of data</h2>
<p>In order to prepare this data for analysis the worksheet for weekly figures was extracted and the data was moved to long form and merged together over the available years. This was extracted in April 2020 when full previous years’ data was available.</p>
<p>The dataset contains:</p>
<ul>
<li>
<strong>category_1:</strong> character, containing the names of the groups for counts, e.g. “Total deaths”, “all ages”.</li>
<li>
<strong>category_2:</strong> character, subcategory of names of groups where necessary, e.g. details of region: “East”, details of age bands “15-44”.</li>
<li>
<strong>counts:</strong> numeric, numbers of deaths in whole numbers and average numbers with decimal points. To retain the integrity of the format this column data is left as character.</li>
<li>
<strong>date:</strong> date, format is yyyy-mm-dd; all dates are a Friday.</li>
<li>
<strong>week_no:</strong> integer, each week in a year is numbered sequentially.</li>
</ul>
</div>
<div id="source-and-licence-acknowledgement" class="section level1">
<h1 class="hasAnchor">
<a href="#source-and-licence-acknowledgement" class="anchor"></a>Source and licence acknowledgement</h1>
<p>This data has been made available through Office of National Statistics under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government Licence</a>.</p>
<p>The main page for downloads is <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/datasets/weeklyprovisionalfiguresondeathsregisteredinenglandandwales">here</a>.</p>
<div id="creating-the-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-the-dataset" class="anchor"></a>Creating the dataset</h2>
<p>Spreadsheets are in xls format from 2010 to 2019.</p>
<p>Each week is released with a new file name listing the week number and all weeks for that year are included in the spreadsheet. Counts for weeks ahead are missing and listed as NA.</p>
<p>When a year has passed it is renamed to the year name and does not change.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># 2019</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2019/publishedweek522019.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2019Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2018</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2018/publishedweek522018withupdatedrespiratoryrow.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2018Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2017</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2017/publishedweek522017.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2017Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2016</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2016/publishedweek522016.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2016Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2015</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2015/publishedweek2015.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2015Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2014</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2014/publishedweek2014.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2014Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2013</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2013/publishedweek2013.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2013Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2012</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2012/publishedweek2012.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2012Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2011</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2011/publishedweek2011.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2011Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)

<span class="co"># 2010</span>
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(
  <span class="st">"https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fbirthsdeathsandmarriages%2fdeaths%2fdatasets%2fweeklyprovisionalfiguresondeathsregisteredinenglandandwales%2f2010/publishedweek2010.xls"</span>,
  <span class="kw">destfile</span> <span class="kw">=</span> <span class="st">"2010Mortality.xls"</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"wininet"</span>,
  <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)</pre></body></html></div>
</div>
<div id="extracting-worksheets-to-csv" class="section level2">
<h2 class="hasAnchor">
<a href="#extracting-worksheets-to-csv" class="anchor"></a>Extracting worksheets to csv</h2>
<p>The data can be found in the worksheet called Weekly figures “date/year”. Other worksheets in spreadsheets 2010 to 2019 are:</p>
<ul>
<li>Contents</li>
<li>Information</li>
<li>Terms and conditions</li>
<li>Weekly figures <year></year>
</li>
<li>Related publications</li>
</ul>
<p>The following code finds the tab name and then creates a csv file for each tab/worksheet.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">readxl</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="no">files_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span> <span class="st">"working_files"</span>,
                         <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"*.xls"</span>,
                         <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)


<span class="no">read_then_csv</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">sheet</span>, <span class="no">path</span>) {
  <span class="no">pathbase</span> <span class="kw">&lt;-</span> <span class="no">path</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span>() <span class="kw">%&gt;%</span>
    <span class="kw pkg">tools</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/tools/fileutils.html">file_path_sans_ext</a></span>()
  <span class="no">path</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span>(<span class="kw">sheet</span> <span class="kw">=</span> <span class="no">sheet</span>) <span class="kw">%&gt;%</span>
    <span class="fu">write_csv</span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">pathbase</span>, <span class="st">"-"</span>, <span class="no">sheet</span>, <span class="st">".csv"</span>))
}


<span class="kw">for</span>(<span class="no">j</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">files_list</span>)){

  <span class="no">path</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">files_list</span>[<span class="no">j</span>])

  <span class="no">path</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu">set_names</span>() <span class="kw">%&gt;%</span>
    <span class="fu">map</span>(<span class="no">read_then_csv</span>, <span class="kw">path</span> <span class="kw">=</span> <span class="no">path</span>)
}</pre></body></html></div>
</div>
<div id="loading-the-weekly-figure-worksheets" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-the-weekly-figure-worksheets" class="anchor"></a>Loading the weekly figure worksheets</h2>
<p>From 2010 to 2015 the tab name was Weekly Figures then it changed capitalisation to Weekly figures.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">files_list_sheets</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span> <span class="st">"working_files"</span>,
                         <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"Weekly"</span>,
                         <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>
                         )

<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="no">files_list_sheets</span>) {

  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="fu">read_csv</span>((<span class="no">i</span>), <span class="kw">col_types</span> <span class="kw">=</span> <span class="fu">cols</span>(<span class="kw">.default</span> <span class="kw">=</span> <span class="fu">col_character</span>()))

  <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span>(<span class="no">i</span>, <span class="no">x</span>)
}</pre></body></html></div>
</div>
<div id="format-data-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#format-data-functions" class="anchor"></a>Format data functions</h2>
<p>Two functions were required to format the spreadsheets as there were changes to the layout from 2016.</p>
<p>Packages used:</p>
<ul>
<li>
<strong>janitor:</strong> a specific package for cleaning data from Excel used here to remove the blank lines and columns, convert Excel serial numbers to dates and to format all column headers by removing spaces in those header names and removing capitalisation.</li>
<li>
<strong>tidyverse:</strong> specifically dplyr for data manipulation.</li>
<li>
<strong>stringi:</strong> a package to works with strings and was used to find certain characters or words.</li>
<li>
<strong>lubridate:</strong> a package to work with dates and used here to format dates to the same format.</li>
</ul>
<div id="section" class="section level3">
<h3 class="hasAnchor">
<a href="#section" class="anchor"></a>2010 - 2015</h3>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">janitor</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">stringi</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lubridate</span>)

<span class="co"># Column names that are not related to data points to be removed. This is the same for all years' spreadsheets.</span>
<span class="co"># Note that single quotes are used for the categories as one sentence includes '' in the text (4). </span>

<span class="no">remove_lookup</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'week over the previous five years1'</span>,
  <span class="st">'Deaths by underlying cause2,3'</span>,
  <span class="st">'Footnotes'</span>,
  <span class="st">'1 This average is based on the actual number of death registrations recorded for each corresponding week over the previous five years. Moveable public holidays, when register offices are closed, affect the number of registrations made in the published weeks and in the corresponding weeks in previous years.'</span>,
  <span class="st">'2 Counts of deaths by underlying cause exclude deaths at age under 28 days.'</span>,
  <span class="st">'3 Coding of deaths by underlying cause for the latest week is not yet complete.'</span>,
  <span class="st">"4Does not include deaths where age is either missing or not yet fully coded. For this reason counts of 'Persons', 'Males' and 'Females' may not sum to 'Total Deaths, all ages'."</span>,
  <span class="st">'5 Does not include deaths of those resident outside England and Wales or those records where the place of residence is either missing or not yet fully coded. For this reason counts for "Deaths by Region of usual residence" may not sum to "Total deaths, all ages".'</span>,
  <span class="st">'Source: Office for National Statistics'</span>,
  <span class="st">'Deaths by age group'</span>
)

<span class="no">formatFunction</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">file</span>){

<span class="no">ONS</span> <span class="kw">&lt;-</span> <span class="no">file</span> <span class="kw">%&gt;%</span>
  <span class="no">clean_names</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/remove_empty.html">remove_empty</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"rows"</span>,<span class="st">"cols"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="no">contents</span> <span class="kw">%in%</span> <span class="no">remove_lookup</span>) <span class="kw">%&gt;%</span>

  <span class="co"># useful categories are found in the column contents but also include the footnote number</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">Category</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x2</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">contents</span>, <span class="st">"Region"</span>) ~ <span class="st">"Region"</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x2</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">contents</span>, <span class="st">"Persons"</span>) ~ <span class="st">"Persons"</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x2</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">contents</span>, <span class="st">"Females"</span>) ~ <span class="st">"Females"</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x2</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">contents</span>, <span class="st">"Males"</span>) ~ <span class="st">"Males"</span>)
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">contents</span>, <span class="no">Category</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">everything</a></span>()) <span class="kw">%&gt;%</span>

  <span class="co"># to ensure data like Persons, Males and Females </span>
  <span class="fu">fill</span>(<span class="no">Category</span>) <span class="kw">%&gt;%</span>

  <span class="co"># categories with Persons, Males and Females in the original column do not correspond directly to data points (wide form data) so are removed by referring to str_detect to find the word</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="fu">str_detect</span>(<span class="no">contents</span>, <span class="st">"Persons"</span>),
         !<span class="fu">str_detect</span>(<span class="no">contents</span>, <span class="st">"Males"</span>),
         !<span class="fu">str_detect</span>(<span class="no">contents</span>, <span class="st">"Females"</span>)) <span class="kw">%&gt;%</span>

  <span class="co"># the two columns for Category and contents are merged to Categories to bring the Category column first. Some categories don't have subcategories and these are preceded by NA_ with this merge</span>
  <span class="fu">unite</span>(<span class="st">"Categories"</span>, <span class="no">Category</span>, <span class="no">contents</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">Categories</span> <span class="kw">!=</span> <span class="st">"Region_Deaths by Region of usual residence 5"</span>) <span class="kw">%&gt;%</span>

  <span class="co"># the NA_ is removed from some of the category names</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">Categories</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu">str_detect</span>(<span class="no">Categories</span>, <span class="st">"NA_"</span>) ~ <span class="fu">str_replace</span>(<span class="no">Categories</span>, <span class="st">"NA_"</span>, <span class="st">""</span>),
                                <span class="fl">TRUE</span> ~ <span class="no">Categories</span>))

  <span class="co"># Push date row to column names</span>
<span class="no">onsFormattedJanitor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/row_to_names.html">row_to_names</a></span>(<span class="no">ONS</span>, <span class="fl">3</span>)

  <span class="co"># move data from wide to long form using pivot_longer</span>
<span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">onsFormattedJanitor</span> <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">`Week ended`</span>,
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"allDates"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"counts"</span>) <span class="kw">%&gt;%</span>

  <span class="co"># some spreadsheets import with Excel serial numbers for dates and others as dates, janitor is used to correct this</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">realDate</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">dmy</a></span>(<span class="no">allDates</span>),
         <span class="kw">ExcelSerialDate</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_length.html">stri_length</a></span>(<span class="no">allDates</span>) <span class="kw">==</span> <span class="fl">5</span> ~ <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/excel_numeric_to_date.html">excel_numeric_to_date</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">allDates</span>), <span class="kw">date_system</span> <span class="kw">=</span> <span class="st">"modern"</span>)),
         <span class="kw">date</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">realDate</span>) ~ <span class="no">ExcelSerialDate</span>,
                          <span class="fl">TRUE</span> ~ <span class="no">realDate</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">`Week ended`</span>) <span class="kw">%&gt;%</span>

  <span class="co"># the week number is replaced as this was lost with the moving of dates to the column headers</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">week_no</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span>()) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>

  <span class="co"># Category is a staging name as this is followed by a splitting of the column into category_1 and category_2</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="kw">Category</span> <span class="kw">=</span> <span class="no">`Week ended`</span>) <span class="kw">%&gt;%</span>

  <span class="co"># to split the columns there are various characters used as a split point ",", "-", and ":" in the respiratory category the version is denoted by "v"</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">category_1</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">","</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fl">1</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">","</span>) -<span class="fl">1</span>),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">":"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fl">1</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">":"</span>) -<span class="fl">1</span>),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"_"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fl">1</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">"_"</span>) -<span class="fl">1</span>),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"respiratory"</span>)  ~
                                  <span class="st">"All respiratory diseases (ICD-10 J00-J99) ICD-10"</span>),
         <span class="kw">category_2</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">","</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">", "</span>) +<span class="fl">2</span>, <span class="fu">str_length</span>(<span class="no">Category</span>)),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">":"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">": "</span>) +<span class="fl">2</span>, <span class="fu">str_length</span>(<span class="no">Category</span>)),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"_"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">"_"</span>) +<span class="fl">1</span>, <span class="fu">str_length</span>(<span class="no">Category</span>)),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"respiratory"</span>)  ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">"v"</span>), <span class="fu">str_length</span>(<span class="no">Category</span>)) ),

         <span class="co"># the data for Total deaths: average of corresponding week over the previous 5 years is split over two cells in the spreasheet</span>
         <span class="kw">category_2</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span>(<span class="no">category_2</span>,
                             <span class="st">"average of corresponding"</span> <span class="kw">=</span> <span class="st">"average of same week over 5 years"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">category_1</span>,
         <span class="no">category_2</span>,
         <span class="no">counts</span>,
         <span class="no">date</span>,
         <span class="no">week_no</span>
         ) <span class="kw">%&gt;%</span>

  <span class="co"># 2011 requires this code to remove rows where there are no counts and because there are 2 rows relating to respiratory death numbers (see the Respiratory section) the previous methodology has been included in the spreadsheet with : for counts. This code does not affect other years' data/</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">counts</span>),
         <span class="no">counts</span> <span class="kw">!=</span> <span class="st">":"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">fill</span>(<span class="no">category_1</span>)

<span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">x</span>)

}

<span class="no">Mortality2010</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction</span>(<span class="no">`working_files/Weekly/2010Mortality-Weekly Figures 2010.csv`</span>)

<span class="co"># 2011 has two lines relating to respiratory, v 2001 only has one data point and the rest of the year is 2010</span>
<span class="no">Mortality2011</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction</span>(<span class="no">`working_files/Weekly/2011Mortality-Weekly Figures 2011.csv`</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">category_2</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">category_2</span>) <span class="kw">&amp;</span> <span class="no">category_1</span> <span class="kw">==</span> <span class="st">"All respiratory diseases (ICD-10 J00-J99) ICD-10"</span> ~ <span class="st">"v 2010"</span>,
                                <span class="fl">TRUE</span> ~ <span class="no">category_2</span>))

<span class="no">Mortality2012</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction</span>(<span class="no">`working_files/Weekly/2012Mortality-Weekly Figures 2012.csv`</span>)
<span class="no">Mortality2013</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction</span>(<span class="no">`working_files/Weekly/2013Mortality-Weekly Figures 2013.csv`</span>)
<span class="no">Mortality2014</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction</span>(<span class="no">`working_files/Weekly/2014Mortality-Weekly Figures 2014.csv`</span>)
<span class="no">Mortality2015</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction</span>(<span class="no">`working_files/Weekly/2015Mortality-Weekly Figures 2015.csv`</span>)</pre></body></html></div>
<div id="format-data-2016---2019" class="section level4">
<h4 class="hasAnchor">
<a href="#format-data-2016---2019" class="anchor"></a>Format data 2016 - 2019</h4>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">formatFunction2016</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">file</span>){

  <span class="no">ONS</span> <span class="kw">&lt;-</span> <span class="no">file</span> <span class="kw">%&gt;%</span>
    <span class="no">clean_names</span> <span class="kw">%&gt;%</span>

    <span class="co"># An extra column has been added for region codes (not included in the dataset) meaning contents are now found in the janitor generated column name x2</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">x2</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x2</span>) ~ <span class="no">contents</span>,
                              <span class="fl">TRUE</span> ~ <span class="no">x2</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/remove_empty.html">remove_empty</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"rows"</span>,<span class="st">"cols"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">contents</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="no">x2</span> <span class="kw">%in%</span> <span class="no">remove_lookup</span>) <span class="kw">%&gt;%</span>

    <span class="co"># Region has changed to region</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">Category</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x3</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">x2</span>, <span class="st">"region"</span>) ~ <span class="st">"Region"</span>,
                                <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x3</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">x2</span>, <span class="st">"Persons"</span>) ~ <span class="st">"Persons"</span>,
                                <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x3</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">x2</span>, <span class="st">"Females"</span>) ~ <span class="st">"Females"</span>,
                                <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">x3</span>) <span class="kw">&amp;</span> <span class="fu">str_detect</span>(<span class="no">x2</span>, <span class="st">"Males"</span>) ~ <span class="st">"Males"</span>,
                                <span class="fl">TRUE</span> ~ <span class="fl">NA_character_</span>)
    ) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">x2</span>, <span class="no">Category</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">everything</a></span>()) <span class="kw">%&gt;%</span>
    <span class="fu">fill</span>(<span class="no">Category</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="fu">str_detect</span>(<span class="no">x2</span>, <span class="st">'Persons'</span>),
           !<span class="fu">str_detect</span>(<span class="no">x2</span>, <span class="st">'Males'</span>),
           !<span class="fu">str_detect</span>(<span class="no">x2</span>, <span class="st">'Females'</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">unite</span>(<span class="st">"Categories"</span>, <span class="no">Category</span>, <span class="no">x2</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">Categories</span> <span class="kw">!=</span> <span class="st">'Region_Deaths by Region of usual residence 5'</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">Categories</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu">str_detect</span>(<span class="no">Categories</span>, <span class="st">"NA_"</span>) ~ <span class="fu">str_replace</span>(<span class="no">Categories</span>, <span class="st">"NA_"</span>, <span class="st">""</span>),
                                  <span class="fl">TRUE</span> ~ <span class="no">Categories</span>))

  <span class="co"># Push date row to column names</span>
  <span class="no">onsFormattedJanitor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/row_to_names.html">row_to_names</a></span>(<span class="no">ONS</span>, <span class="fl">3</span>)

  <span class="co"># move data from wide to long form using pivot_longer</span>
  <span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">onsFormattedJanitor</span> <span class="kw">%&gt;%</span>
    <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">`Week ended`</span>,
                 <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"allDates"</span>,
                 <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"counts"</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">realDate</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">dmy</a></span>(<span class="no">allDates</span>),
           <span class="kw">ExcelSerialDate</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_length.html">stri_length</a></span>(<span class="no">allDates</span>) <span class="kw">==</span> <span class="fl">5</span> ~ <span class="fu"><a href="https://rdrr.io/pkg/janitor/man/excel_numeric_to_date.html">excel_numeric_to_date</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">allDates</span>), <span class="kw">date_system</span> <span class="kw">=</span> <span class="st">"modern"</span>)),
           <span class="kw">date</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">realDate</span>) ~ <span class="no">ExcelSerialDate</span>,
                            <span class="fl">TRUE</span> ~ <span class="no">realDate</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">`Week ended`</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">week_no</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span>()) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="kw">Category</span> <span class="kw">=</span> <span class="no">`Week ended`</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">category_1</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">","</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fl">1</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">","</span>) -<span class="fl">1</span>),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">":"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fl">1</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">":"</span>) -<span class="fl">1</span>),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"_"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fl">1</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">"_"</span>) -<span class="fl">1</span>),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"respiratory"</span>)  ~
                                  <span class="st">"All respiratory diseases (ICD-10 J00-J99) ICD-10"</span>),
         <span class="kw">category_2</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span>(<span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">","</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">", "</span>) +<span class="fl">2</span>, <span class="fu">str_length</span>(<span class="no">Category</span>)),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">":"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">": "</span>) +<span class="fl">2</span>, <span class="fu">str_length</span>(<span class="no">Category</span>)),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"_"</span>) ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">"_"</span>) +<span class="fl">1</span>, <span class="fu">str_length</span>(<span class="no">Category</span>)),
                                <span class="fu">str_detect</span>(<span class="no">Category</span>, <span class="st">"respiratory"</span>)  ~
                                  <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="no">Category</span>,<span class="fu">str_locate</span>(<span class="no">Category</span>, <span class="st">"v"</span>), <span class="fu">str_length</span>(<span class="no">Category</span>)) ),
         <span class="kw">category_2</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span>(<span class="no">category_2</span>,
                             <span class="st">"average of corresponding"</span> <span class="kw">=</span> <span class="st">"average of same week over 5 years"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">category_1</span>,
           <span class="no">category_2</span>,
           <span class="no">counts</span>,
           <span class="no">date</span>,
           <span class="no">week_no</span>
    ) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">counts</span>))

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">x</span>)

}


<span class="no">Mortality2016</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction2016</span>(<span class="no">`working_files/Weekly/2016Mortality-Weekly figures 2016.csv`</span>)
<span class="no">Mortality2017</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction2016</span>(<span class="no">`working_files/Weekly/2017Mortality-Weekly figures 2017.csv`</span>)
<span class="no">Mortality2018</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction2016</span>(<span class="no">`working_files/Weekly/2018Mortality-Weekly figures 2018.csv`</span>)
<span class="no">Mortality2019</span> <span class="kw">&lt;-</span> <span class="fu">formatFunction2016</span>(<span class="no">`working_files/Weekly/2019Mortality-Weekly figures 2019.csv`</span>)</pre></body></html></div>
</div>
</div>
</div>
<div id="bind-together" class="section level2">
<h2 class="hasAnchor">
<a href="#bind-together" class="anchor"></a>Bind together</h2>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">ons_mortality</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
                      <span class="no">Mortality2010</span>,
                      <span class="no">Mortality2011</span>,
                      <span class="no">Mortality2012</span>,
                      <span class="no">Mortality2013</span>,
                      <span class="no">Mortality2014</span>,
                      <span class="no">Mortality2015</span>,
                      <span class="no">Mortality2016</span>,
                      <span class="no">Mortality2017</span>,
                      <span class="no">Mortality2018</span>,
                      <span class="no">Mortality2019</span>))</pre></body></html></div>
</div>
<div id="load-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#load-the-data" class="anchor"></a>Load the data</h2>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">NHSRdatasets</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"ons_mortality"</span>)</pre></body></html></div>
</div>
<div id="respiratory" class="section level2">
<h2 class="hasAnchor">
<a href="#respiratory" class="anchor"></a>Respiratory</h2>
<p>Deaths by underlying cause of respiratory diseases All respiratory diseases (ICD-10 J00-J99) appear as:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">ons_mortality</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">year</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span>(<span class="no">date</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">year</span>, <span class="no">category_1</span>, <span class="no">category_2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">year</span>, <span class="no">category_1</span>, <span class="no">category_2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">category_1</span> <span class="kw">==</span> <span class="st">'All respiratory diseases (ICD-10 J00-J99) ICD-10'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span>(<span class="fl">1</span>)</pre></body></html></div>
<p>Notes from the spreadsheets in relation to these methodology changes:</p>
<div id="section-1" class="section level3">
<h3 class="hasAnchor">
<a href="#section-1" class="anchor"></a>2011</h3>
<ul>
<li>Respiratory deaths for 2011 are coded to the new version of ICD-10 while for 2010 they are coded to the previous version. Week 1 2011 has been coded to both versions to give an indication of the impact of the change.</li>
</ul>
</div>
<div id="section-2" class="section level3">
<h3 class="hasAnchor">
<a href="#section-2" class="anchor"></a>2014</h3>
<ul>
<li><p>For deaths registered from January 2014, cause of death is coded to the ICD-10 classification using IRIS software. Further information about the implementation of the software is available on the ONS website.</p></li>
<li><p>All deaths registered in week 2 were dual-coded using both ICD-10 v2010 (NCHS) and ICD-10 v2013 (IRIS). An information note providing the preliminary findings on the impact of the implementation of IRIS software for ICD-10 cause of death coding on mortality statistics in England and Wales is available on the ONS website.</p></li>
</ul>
</div>
<div id="section-3" class="section level3">
<h3 class="hasAnchor">
<a href="#section-3" class="anchor"></a>2015</h3>
<ul>
<li>For deaths registered from January 2014, cause of death is coded to the ICD-10 classification using IRIS software. Further information about the <a href="https://webarchive.nationalarchives.gov.uk/20160106020045/http://www.ons.gov.uk/ons/guide-method/user-guidance/health-and-life-events/Changes-to-cause-of-death-coding-in-England-and-Wales/index.html">implementation of the software</a> is available on the ONS website.</li>
</ul>
</div>
</div>
<div id="age-bands" class="section level2">
<h2 class="hasAnchor">
<a href="#age-bands" class="anchor"></a>Age bands</h2>
<p>Numbers are provided for categories: Persons, Females and Males.</p>
<p>As detailed in the notes, if the age is missing or not coded at the time of release then the counts of ‘Persons’, ‘Males’ and ‘Females’ may not sum to ‘Total Deaths, all ages’.</p>
<p>Note that these age bands were changed in 2020 releases.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">ons_mortality</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">category_1</span>, <span class="no">category_2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">category_1</span>, <span class="no">category_2</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">category_1</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'Persons'</span>,<span class="st">'Females'</span>,<span class="st">'Males'</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span>(<span class="fl">1</span>)</pre></body></html></div>
</div>
<div id="remove-working_files-folder" class="section level2">
<h2 class="hasAnchor">
<a href="#remove-working_files-folder" class="anchor"></a>Remove working_files folder</h2>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span>(<span class="st">"working_files"</span>, <span class="kw">recursive</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.mainard.co.uk">Chris Mainey</a>, <a href="https://github.com/tomjemmett">Tom Jemmett</a>, <a href="https://github.com/Lextuga007">Zoë Turner</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
